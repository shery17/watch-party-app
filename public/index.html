<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Watch Party App</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet"
   integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
</head>
<body class="bg-light d-flex justify-content-center mt-5 min-vh-100">
  <div class="container text-center">
    <h1 class="text-center mt-4 mb-4 display-4" style="font-family: 'Segoe UI', sans-serif;">Watch Party App</h1>

    <!-- Session Controls -->
    <div class="mb-3">
      <p id="sessionDisplay"><strong>Session ID:</strong></p>
      <button id="copyLinkBtn" class="btn btn-secondary me-2">Copy Session Link</button>
      <button id="newSessionBtn" class="btn btn-secondary">Start New Session</button>
    </div>

    <!-- File Input (Local Playback Only) -->
    <div class="mb-3">
      <input type="file" name="videoFile" id="videoFileInput" accept="video/mp4" class="form-control w-auto mx-auto">
      <div id="fileMismatchWarning" style="color: red; display: none;" class="mt-2">
        ⚠️ Warning: The video file name does not match others in this session.
      </div>
    </div>

    <!-- Responsive Video Player and Description -->
    <div class="container mt-4">
      <div class="mx-auto" style="max-width: 640px;">
        <div class="ratio ratio-16x9 mb-3">
          <video id="videoPlayer" controls class="border rounded shadow-sm w-100 h-100"></video>
        </div>
        
        <div class="bg-light p-3 p-md-4 border rounded text-start lh-base">
          <p class="text-muted mb-3">
            <strong>Friendly Reminder:</strong></br>Everyone must load the exact same video file on their device for playback to stay in sync.
          </p>
          <p class="text-muted mb-3">
            <strong>Having Issues?</strong></br> If you’re unsure about setup or run into issues, see the 
            <a href="README.md" target="_blank">README</a> for detailed instructions.
          </p>
        </div>
        
    </div>

  <!-- Socket.IO -->
  <script src="/socket.io/socket.io.js"></script>
  
  <script>
    const videoPlayer = document.getElementById('videoPlayer');
    const fileInput = document.getElementById('videoFileInput');
    const warning = document.getElementById('fileMismatchWarning');

    const pathParts = window.location.pathname.split('/');
    let sessionId = pathParts[2];
    if (!sessionId) {
      sessionId = Math.random().toString(36).substring(2, 10);
      window.location.href = `/session/${sessionId}`;
    }

    document.getElementById('sessionDisplay').innerText = `Session ID: ${sessionId}`;

    document.getElementById('copyLinkBtn').addEventListener('click', () => {
      const sessionLink = `${window.location.origin}/session/${sessionId}`;
      navigator.clipboard.writeText(sessionLink)
        .then(() => alert('Session link copied!'))
        .catch(err => console.error('Copy failed:', err));
    });

    document.getElementById('newSessionBtn').addEventListener('click', () => {
      const newSession = Math.random().toString(36).substring(2, 10);
      window.location.href = `/session/${newSession}`;
    });

    const socket = io();
    socket.emit('joinRoom', sessionId);

    let suppressEvent = false;
    let localFileName = '';
    let fileNamesInRoom = new Set();

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const url = URL.createObjectURL(file);
        videoPlayer.src = url;
        videoPlayer.load();
        localFileName = file.name;
        socket.emit('fileName', localFileName);
        fileNamesInRoom.add(localFileName);
        checkForMismatch();
      }
    });

    // Update and compare file names from others
    socket.on('fileName', (receivedName) => {
      fileNamesInRoom.add(receivedName);
      checkForMismatch();
    });

    function checkForMismatch() {
      if (localFileName && fileNamesInRoom.size > 1) {
        warning.style.display = 'block';
      } else {
        warning.style.display = 'none';
      }
    }

    // Playback sync
    videoPlayer.addEventListener('play', () => {
      if (!suppressEvent && videoPlayer.src) {
        socket.emit('play', videoPlayer.currentTime);
      }
      suppressEvent = false;
    });

    videoPlayer.addEventListener('pause', () => {
      if (!suppressEvent && videoPlayer.src) {
        socket.emit('pause', videoPlayer.currentTime);
      }
      suppressEvent = false;
    });

    videoPlayer.addEventListener('seeked', () => {
      if (!suppressEvent && videoPlayer.src) {
        socket.emit('seek', videoPlayer.currentTime);
      }
      suppressEvent = false;
    });

    socket.on('play', (currentTime) => {
      if (videoPlayer.src) {
        suppressEvent = true;
        videoPlayer.currentTime = currentTime;
        videoPlayer.play();
      }
    });

    socket.on('pause', (currentTime) => {
      if (videoPlayer.src) {
        suppressEvent = true;
        videoPlayer.currentTime = currentTime;
        videoPlayer.pause();
      }
    });

    socket.on('seek', (currentTime) => {
      if (videoPlayer.src) {
        suppressEvent = true;
        videoPlayer.currentTime = currentTime;
      }
    });
  </script>

</body>
</html>
